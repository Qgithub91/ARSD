rm(list = ls())

pacman::p_load(
  tidyverse, igraph, readxl
)

# 导入相关性系数，并转换为邻接矩阵数据。
high.data <- read_excel("High.20250402.cor.0.98.xlsx") %>% 
  column_to_rownames("rowname") %>% 
  mutate(across(everything(), ~ ifelse(. > 0, 1, .)))
low.data <- read_excel("Low.20250402.cor.0.98.xlsx") %>% 
  column_to_rownames("rowname") %>% 
  mutate(across(everything(), ~ ifelse(. > 0, 1, .)))
otu.taxa <- read.table("J:/abundance_division/otu.taxa.tsv", header = T, row.names = 1, sep = "\t") %>% 
  as.data.frame()
taxonomy <- readxl::read_xlsx("J:/rawdata/otu_table.xlsx", sheet = "taxonomy")  

#定义函数，计算网络中节点的重要性，并根据重要性依次移出节点后，计算网络的自然连通度
nc <- function(g) {
  natcon <- function(g) {
    N   <- vcount(g)
    adj <- get.adjacency(g)
    evals <- eigen(adj)$value
    nc <- log(mean(exp(evals)))
    nc / (N - log(N))
  }
  nc.attack <- function(g) {
    # 综合排序（介数优先，再度）
    hubord <- order(rank(betweenness(g)), rank(degree(g)), decreasing=TRUE)
    # 记录删除顺序的节点名称
    removal_order <- V(g)$name[hubord]
    # 计算删除后的自然连通度，原来是round(vcount(g)*.8
    nc_values <- sapply(1:round(vcount(g)), function(i) {
      ind <- hubord[1:i]
      tmp <- delete_vertices(g, V(g)$name[ind])
      natcon(tmp)
    })
    
    list(nc = nc_values, removal_order = removal_order)
  }
  
  result <- nc.attack(g)
  return(result)
}

#转换网络数据（邻接矩阵 -> R 的网络数据结构）
high.g <- graph_from_adjacency_matrix(as.matrix(high.data), mode = 'undirected', diag = FALSE)
low.g <- graph_from_adjacency_matrix(as.matrix(low.data), mode = 'undirected', diag = FALSE)

#计算自然连通度
high_result <- nc(high.g)
high_nc <- high_result$nc
high_removal_order <- high_result$removal_order

low_result <- nc(low.g)
low_nc <- low_result$nc
low_removal_order <- low_result$removal_order

dat <- data.frame(
  network = c(rep('high.g', length(high_nc)), rep('low.g', length(low_nc))), 
  Proportion.of.removes.nodes = c((1:length(high_nc))/length(high_nc), (1:length(low_nc))/length(low_nc)),
  Natural.Connectivity = c(high_nc, low_nc), 
  removal.otu = c(high_removal_order, low_removal_order), check.names = FALSE
) %>% 
  left_join(otu.taxa[,c("otus", "staxa")], by = c("removal.otu" = "otus")) %>% 
  left_join(taxonomy, by = c("removal.otu" = "otus"))
  

write.table(dat, paste0(format(Sys.time(), "%Y%m%d"), ".natural.connectivity.1.0.tsv"), 
            sep = "\t", quote = F, col.names = T, row.names = F)

dat <- read.table("20250412.natural.connectivity.0.8.tsv", header = T, sep = "\t")

select.dat <- subset(dat, Proportion.of.removes.nodes <= 1)

#作图
nc.plot <- ggplot(select.dat, aes(x = Proportion.of.removes.nodes, y = Natural.Connectivity, color = network)) +
  geom_point() +
  scale_color_manual(values = c("#7A1B6D", "#91D540"), name = "Network") +
  theme_bw() +
  labs(x = 'Proportion of removes nodes', y = 'Natural Connectivity')+
  theme(panel.grid = element_blank(),
        axis.text=element_text(color="black", size = 16),
        axis.title = element_text(color="black", size = 18),
        legend.text = element_text(color="black", size = 16),
        legend.title = element_text(color="black", size = 18))

ggsave(paste0(format(Sys.time(), "%Y%m%d"), ".natural.connectivity.1.0.pdf"), nc.plot, width = 5, height = 4, dpi = 300)

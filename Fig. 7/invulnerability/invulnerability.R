rm(list = ls())

pacman::p_load(
  tidyverse, igraph, readxl, furrr, Matrix, RSpectra, progressr
)

#=========================
# å‚æ•°è®¾ç½®
#=========================
step_size <- 1       # æ¯éš”å¤šå°‘æ­¥è®¡ç®—ä¸€æ¬¡
top_k_eigen <- 200   # è®¡ç®—å‰å¤šå°‘ä¸ªç‰¹å¾å€¼
log_file <- paste0("natural_connectivity_log_", format(Sys.time(), "%Y%m%d_%H%M"), ".txt")

plan(multisession, workers = parallel::detectCores() - 1)
handlers(global = TRUE)  # progressr è¿›åº¦æ¡å¯ç”¨

#=========================
# æ•°æ®å¯¼å…¥
#=========================
high.data <- read_excel("High.20251106.cor.0.7.xlsx") %>% 
  column_to_rownames("rowname") %>% 
  mutate(across(everything(), ~ ifelse(. > 0, 1, .)))

low.data <- read_excel("Low.20251106.cor.0.7.xlsx") %>% 
  column_to_rownames("rowname") %>% 
  mutate(across(everything(), ~ ifelse(. > 0, 1, .)))

otu.taxa <- read.table(
  "I:/å·¥ä½œ/ä¸“åˆ©ã€æ–‡ç« æ’°å†™/é«˜æ¸©å¤§æ›²ç¨€æœ‰å’Œä¸°å¯Œç‰©ç§åˆ†æ/æ•°æ®åˆ†æ/ä¸°åº¦åˆ’åˆ†/otu.taxa.tsv",
  header = TRUE, row.names = 1, sep = "\t"
) %>% as.data.frame()

taxonomy <- read_excel(
  "I:/å·¥ä½œ/ä¸“åˆ©ã€æ–‡ç« æ’°å†™/é«˜æ¸©å¤§æ›²ç¨€æœ‰å’Œä¸°å¯Œç‰©ç§åˆ†æ/æ•°æ®åˆ†æ/åŸå§‹æ•°æ®/otu_table.xlsx",
  sheet = "taxonomy"
)

#=========================
# ä¼˜åŒ–åçš„è‡ªç„¶è¿é€šåº¦å‡½æ•°
#=========================
nc_fast_log <- function(g, step = 5, k = 100, netname = "network") {
  message("å¼€å§‹è®¡ç®—ç½‘ç»œï¼š", netname, "ï¼ˆèŠ‚ç‚¹æ•°=", vcount(g), "ï¼‰")
  write(paste0("\n==== å¼€å§‹ç½‘ç»œï¼š", netname, " ", Sys.time(), " ====\n"), 
        file = log_file, append = TRUE)
  
  adj0 <- get.adjacency(g)
  hubord <- order(rank(betweenness(g)), rank(degree(g)), decreasing = TRUE)
  removal_order <- V(g)$name[hubord]
  N_remove <- round(vcount(g) * 0.8)
  steps <- seq(1, N_remove, by = step)
  
  # ======== å®¹é”™ç‰ˆç‰¹å¾å€¼è®¡ç®—å‡½æ•° ========
  natcon <- function(adj) {
    adj <- Matrix(adj, sparse = TRUE)
    n <- nrow(adj)
    # è‡ªåŠ¨è°ƒèŠ‚kï¼Œé˜²æ­¢å°å›¾æ¯”kå°
    k_use <- min(k, max(2, n - 2))
    
    # æ•è·é”™è¯¯
    res <- tryCatch({
      evals <- eigs(adj, k = k_use, which = "LM")$values
      log(mean(exp(Re(evals)))) / (n - log(n))
    }, error = function(e) {
      msg <- sprintf("âš ï¸ å­å›¾ç‰¹å¾å€¼è®¡ç®—å¤±è´¥ (size=%d, k=%d): %s", n, k_use, e$message)
      write(paste0("[", Sys.time(), "] ", msg, "\n"), file = log_file, append = TRUE)
      return(NA)
    })
    return(res)
  }
  
  # ======== è¿­ä»£è®¡ç®—ï¼ˆå¸¦è¿›åº¦å’Œæ—¥å¿—ï¼‰ ========
  nc_values <- c()
  
  with_progress({
    p <- progressor(along = steps)
    nc_values <- future_map_dbl(steps, function(i) {
      t0 <- Sys.time()
      remain <- setdiff(1:vcount(g), hubord[1:i])
      nc_i <- natcon(adj0[remain, remain])
      elapsed <- round(as.numeric(Sys.time() - t0, units = "secs"), 2)
      write(sprintf("[%s] Step %d/%d | %.2fs | NC=%.4f\n", 
                    netname, i, N_remove, elapsed, nc_i),
            file = log_file, append = TRUE)
      p(message = sprintf("%s: %.1f%% done", netname, i / N_remove * 100))
      return(nc_i)
    })
  })
  
  write(paste0("==== å®Œæˆç½‘ç»œï¼š", netname, " ", Sys.time(), " ====\n"), 
        file = log_file, append = TRUE)
  
  list(
    nc = nc_values,
    removal_order = removal_order[steps],
    steps = steps
  )
}


#=========================
# æ„å»ºç½‘ç»œ
#=========================
high.g <- graph_from_adjacency_matrix(abs(as.matrix(high.data)), mode = 'undirected', diag = FALSE)
low.g  <- graph_from_adjacency_matrix(abs(as.matrix(low.data)), mode = 'undirected', diag = FALSE)

#=========================
# è®¡ç®—è‡ªç„¶è¿é€šåº¦ï¼ˆåŠ é€Ÿ + æ—¥å¿—ç‰ˆï¼‰
#=========================
system.time({
  high_result <- nc_fast_log(high.g, step = step_size, k = top_k_eigen, netname = "High Network")
  low_result  <- nc_fast_log(low.g,  step = step_size, k = top_k_eigen, netname = "Low Network")
})

# =========================
# æ•´ç†ç»“æœ
#=========================
dat <- data.frame(
  network = c(rep('high.g', length(high_result$nc)), rep('low.g', length(low_result$nc))), 
  Proportion.of.removes.nodes = c(high_result$steps / vcount(high.g),
                                  low_result$steps / vcount(low.g)),
  Natural.Connectivity = c(high_result$nc, low_result$nc),
  removal.otu = c(high_result$removal_order, low_result$removal_order),
  check.names = FALSE
) %>% 
  left_join(otu.taxa[,c("otus", "staxa")], by = c("removal.otu" = "otus")) %>% 
  left_join(taxonomy, by = c("removal.otu" = "otus"))

#=========================
# å¯¼å‡ºç»“æœ
#=========================
outname <- paste0("RT.", format(Sys.time(), "%Y%m%d"), ".natural.connectivity.fast.tsv")
write.table(dat, outname, sep = "\t", quote = FALSE, col.names = TRUE, row.names = FALSE)
message("âœ… ç»“æœå·²ä¿å­˜ä¸ºï¼š", outname)
message("ğŸ“„ æ—¥å¿—æ–‡ä»¶ï¼š", log_file)

#=========================
# ä½œå›¾
#=========================
select.dat <- subset(dat, Proportion.of.removes.nodes <= 1)

nc.plot <- ggplot(select.dat, aes(x = Proportion.of.removes.nodes, y = Natural.Connectivity, color = network)) +
  geom_point() +
  scale_color_manual(values = c("#7A1B6D", "#91D540"), name = "Network") +
  theme_bw() +
  labs(x = 'Proportion of removes nodes', y = 'Natural Connectivity') +
  theme(panel.grid = element_blank(),
        axis.text=element_text(color="black", size = 16),
        axis.title = element_text(color="black", size = 18),
        legend.text = element_text(color="black", size = 16),
        legend.title = element_text(color="black", size = 18))

nc.plot

ggsave(paste0(format(Sys.time(), "%Y%m%d"), ".natural.connectivity.fast.pdf"),
       nc.plot, width = 5, height = 4, dpi = 300)
